# USER DIRECTIVES:
AI is encouraged to use custom queries here if helper functions do not satisfy needs. The user directives is AI territory for management and follow-through. It can use the way AIFP works separate from user directives as a guide on how to manage user directives if useful. 

## user_directives
name TEXT NOT NULL UNIQUE,                      -- e.g., 'turn_off_lights_5pm', 'monitor_stove'
    source_file TEXT NOT NULL,                      -- e.g., 'directives/home_automation.yaml'
    source_format TEXT NOT NULL CHECK (source_format IN ('yaml', 'json', 'txt')),
    domain TEXT,                                    -- e.g., 'home_automation', 'aws_infrastructure', 'custom'
    description TEXT,                               -- Human-readable description
    raw_content TEXT NOT NULL,                      -- Original user-provided directive text
    validated_content JSON NOT NULL,                -- AI-validated and structured directive

    -- Trigger information
    trigger_type TEXT NOT NULL CHECK (trigger_type IN ('time', 'event', 'condition', 'manual')),
    trigger_config JSON NOT NULL,                   -- e.g., {"time": "17:00", "timezone": "America/New_York"}

    -- Action information
    action_type TEXT NOT NULL,                      -- e.g., 'api_call', 'script_execution', 'function_call'
    action_config JSON NOT NULL,                    -- e.g., {"api": "homeassistant", "endpoint": "/lights/off"}

    -- Status and lifecycle
    status TEXT DEFAULT 'pending_validation' CHECK (status IN (
        'pending_validation',   -- Initial state, needs AI validation
        'validated',            -- AI validated, ready for implementation
        'implementing',         -- AI generating implementation code
        'implemented',          -- Code generated, not yet active
        'active',              -- Running and monitoring
        'paused',              -- Temporarily disabled
        'error',               -- Execution error occurred
        'deprecated'           -- No longer in use
    )),

    -- Implementation tracking
    implementation_status TEXT DEFAULT 'not_started' CHECK (implementation_status IN (
        'not_started',
        'in_progress',
        'completed',
        'failed'
    )),
    implementation_file_path TEXT,                  -- e.g., '.aifp-project/generated/handlers/lights_5pm.py'

    -- Validation tracking
    validation_questions JSON,                      -- Questions asked during validation
    validation_answers JSON,                        -- User's answers
    validated_at DATETIME,
    validated_by TEXT DEFAULT 'ai',

    -- Approval tracking (user testing and approval)
    approved BOOLEAN DEFAULT 0,                     -- User has tested and approved implementation
    approved_at DATETIME,                           -- When user approved

    -- Metadata
    priority INTEGER DEFAULT 0,                     -- Higher = more important
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    activated_at DATETIME,                          -- When directive became active
    last_modified_at DATETIME                       -- When source file was last modified

## directive_executions
directive_id INTEGER NOT NULL,

    -- Summary statistics only (detailed logs in files)
    last_execution_time DATETIME,
    next_scheduled_time DATETIME,                   -- For time-based triggers
    total_executions INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 0,
    error_count INTEGER DEFAULT 0,

    -- Last error info (for quick status checks)
    last_error_time DATETIME,
    last_error_type TEXT,                           -- e.g., 'connection_error', 'timeout', 'validation_error'
    last_error_message TEXT,                        -- Brief error message (full details in error log file)

    -- Performance metrics
    avg_execution_time_ms REAL,                     -- Average execution time in milliseconds
    max_execution_time_ms REAL,

## directive_dependencies
directive_id INTEGER NOT NULL,

    -- Dependency information
    dependency_type TEXT NOT NULL CHECK (dependency_type IN (
        'python_package',       -- Python package (pip install)
        'system_package',       -- System package (apt, brew, etc.)
        'api_service',          -- External API (Home Assistant, AWS, etc.)
        'file',                 -- File or directory dependency
        'environment_variable', -- Required environment variable
        'hardware'             -- Hardware dependency (e.g., specific sensor)
    )),
    dependency_name TEXT NOT NULL,                  -- e.g., 'boto3', 'homeassistant-api', 'GPIO'
    dependency_version TEXT,                        -- e.g., '>=1.20.0', '2.0.1'

    -- Installation status
    status TEXT DEFAULT 'not_installed' CHECK (status IN (
        'not_installed',
        'pending_confirmation',     -- AI detected, waiting for user confirmation
        'installing',
        'installed',
        'failed',
        'not_available'
    )),

    -- Installation details
    install_command TEXT,                           -- e.g., 'pip install boto3>=1.20.0'
    user_confirmed BOOLEAN DEFAULT 0,               -- User approved installation
    confirmed_at DATETIME,
    installed_at DATETIME,

    -- Metadata
    required BOOLEAN DEFAULT 1,                     -- Is this dependency required or optional?
    description TEXT,

## directive_implementations
directive_id INTEGER NOT NULL,

    -- Implementation details
    implementation_type TEXT NOT NULL CHECK (implementation_type IN (
        'event_handler',        -- Event-driven handler
        'scheduler',            -- Time-based scheduler (cron job)
        'service',             -- Long-running background service
        'function',            -- Simple function call
        'script'               -- Standalone script
    )),
    file_path TEXT NOT NULL,                        -- e.g., 'src/handlers/lights_5pm.py'
    function_name TEXT,                             -- e.g., 'handle_lights_5pm'

    -- Code metadata
    language TEXT DEFAULT 'python',
    framework TEXT,                                 -- e.g., 'asyncio', 'celery', 'apscheduler'
    entry_point TEXT,                               -- How to execute (e.g., 'python handlers/lights_5pm.py')

    -- Deployment status
    deployed BOOLEAN DEFAULT 0,
    deployed_at DATETIME,
    process_id INTEGER,                             -- PID if running as background service

    -- File tracking
    file_checksum TEXT,                             -- MD5/SHA256 checksum for change detection

## directive_relationships
source_directive_id INTEGER NOT NULL,
    target_directive_id INTEGER NOT NULL,

    relationship_type TEXT NOT NULL CHECK (relationship_type IN (
        'depends_on',           -- Source depends on target completing first
        'triggers',            -- Source triggers target
        'conflicts_with',      -- Source and target cannot both be active
        'enhances'             -- Source enhances target's functionality
    )),

    description TEXT,
    active BOOLEAN DEFAULT 1,

## helper_functions
name TEXT NOT NULL UNIQUE,               -- e.g., 'check_lights_status', 'send_aws_notification'
    file_path TEXT,                          -- e.g., 'src/helpers/check_lights.py'
    parameters JSON,                         -- e.g., '["room_id", "threshold"]'
    purpose TEXT,
    error_handling TEXT,

    -- Code tracking (AI-generated implementation functions)
    function_signature TEXT,                 -- e.g., 'def check_lights_status(room_id: str) -> bool:'
    return_type TEXT,                        -- e.g., 'bool', 'dict', 'Result[str, Error]'
    is_pure BOOLEAN DEFAULT 1,               -- Is this a pure function (FP compliance)

    -- Status tracking
    implementation_status TEXT DEFAULT 'not_implemented' CHECK (implementation_status IN (
        'not_implemented',                   -- Function defined but code not yet generated
        'generated',                         -- Code generated by AI
        'tested',                            -- User has tested
        'approved'                           -- User approved and active
    )),

## directive_helpers
directive_id INTEGER NOT NULL,
    helper_function_id INTEGER NOT NULL,
    execution_context TEXT,                  -- e.g., 'validation', 'execution', 'error_handler'
    sequence_order INTEGER DEFAULT 0,        -- Order of execution if multiple helpers
    is_required BOOLEAN DEFAULT 1,           -- TRUE if helper must execute
    parameters_mapping JSON,                 -- Maps directive params to helper params
    description TEXT,                        -- Brief note on why this helper is used

## source_files
file_path TEXT NOT NULL UNIQUE,                 -- e.g., 'directives/home_automation.yaml'
    file_format TEXT NOT NULL CHECK (file_format IN ('yaml', 'json', 'txt')),
    file_checksum TEXT NOT NULL,                    -- MD5/SHA256 checksum for change detection

    -- Parsing status
    last_parsed_at DATETIME,
    parse_status TEXT DEFAULT 'not_parsed' CHECK (parse_status IN (
        'not_parsed',
        'parsing',
        'parsed_successfully',
        'parse_error'
    )),
    parse_error_message TEXT,

    -- Directive count
    directive_count INTEGER DEFAULT 0,
    active_directive_count INTEGER DEFAULT 0,

## logging_config
execution_logs_enabled BOOLEAN DEFAULT 1,
    execution_log_rotation TEXT DEFAULT 'daily' CHECK (execution_log_rotation IN ('daily', 'weekly', 'size')),
    execution_log_retention_days INTEGER DEFAULT 30,
    execution_log_compress_after_days INTEGER DEFAULT 7,
    execution_log_max_size_mb INTEGER DEFAULT 100,  -- For size-based rotation

    -- Error logging (file-based)
    error_logs_enabled BOOLEAN DEFAULT 1,
    error_log_rotation TEXT DEFAULT 'size' CHECK (error_log_rotation IN ('daily', 'weekly', 'size')),
    error_log_retention_days INTEGER DEFAULT 90,    -- Keep errors longer
    error_log_max_size_mb INTEGER DEFAULT 10,
    error_log_format TEXT DEFAULT 'json' CHECK (error_log_format IN ('json', 'text')),

    -- Database logging (statistics only)
    store_execution_statistics BOOLEAN DEFAULT 1,   -- Store summary stats in directive_executions
    store_last_error_only BOOLEAN DEFAULT 1,        -- Only keep last error in DB, rest in files
    store_execution_history BOOLEAN DEFAULT 0,      -- DO NOT store full history in DB (use files)

    -- Log file paths
    execution_log_dir TEXT DEFAULT '.aifp-project/logs/execution/',
    error_log_dir TEXT DEFAULT '.aifp-project/logs/errors/',
    lifecycle_log_path TEXT DEFAULT '.aifp-project/logs/user-directives.log',

## 