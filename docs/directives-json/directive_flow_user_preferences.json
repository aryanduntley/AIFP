{
  "metadata": {
    "description": "User preference meta-directive flows - Managing user-specific AI behavior preferences and settings",
    "version": "1.0.0",
    "created": "2025-12-19",
    "total_flows": 14,
    "scope": "User preference management and customization",
    "key_principles": [
      "User preferences loaded before executing customizable directives",
      "All tracking features are opt-in (default = OFF)",
      "Learning from corrections requires explicit user confirmation",
      "Export/import for backup and portability",
      "Granular control over privacy/tracking features"
    ],
    "directive_types": [
      "Preference loading (user_preferences_sync)",
      "Preference updating (user_preferences_update, user_preferences_learn)",
      "Import/export (user_preferences_export, user_preferences_import)",
      "Logging (project_notes_log)",
      "Privacy controls (tracking_toggle)"
    ],
    "database": "user_preferences.db",
    "tables": [
      "user_settings - Global user settings",
      "directive_preferences - Directive-specific preferences",
      "tracking_settings - Privacy/tracking feature toggles",
      "ai_interaction_log - User corrections and feedback (opt-in)",
      "fp_flow_tracking - FP directive consultation tracking (opt-in)"
    ]
  },
  "flows": [
    {
      "id": 1,
      "from_directive": "aifp_run",
      "to_directive": "user_preferences_sync",
      "flow_type": "conditional",
      "condition_key": "directive_is_customizable",
      "condition_value": "true",
      "condition_description": "Load user preferences before executing any directive that supports customization",
      "priority": 100,
      "description": "Load preferences before executing customizable directives (project_file_write, project_task_decomposition, etc.)",
      "examples": [
        "project_file_write: code style, docstrings, max function length, naming conventions",
        "project_task_decomposition: naming convention, auto-create items, default priority",
        "user_directive_validate: validation strictness",
        "user_directive_implement: code generation preferences"
      ],
      "flow_category": "user_preferences"
    },
    {
      "id": 2,
      "from_directive": "user_preferences_sync",
      "to_directive": "aifp_status",
      "flow_type": "completion_loop",
      "condition_key": null,
      "condition_value": null,
      "condition_description": null,
      "priority": 100,
      "description": "Preferences loaded, return to workflow",
      "flow_category": "user_preferences"
    },
    {
      "id": 3,
      "from_directive": "aifp_status",
      "to_directive": "user_preferences_update",
      "flow_type": "conditional",
      "condition_key": "user_requests_preference_change",
      "condition_value": "true",
      "condition_description": "User explicitly requests to change AI behavior preference",
      "priority": 80,
      "description": "User explicitly updates preferences (e.g., 'always add docstrings', 'never use X pattern')",
      "user_intent_keywords": [
        "set preference",
        "change behavior",
        "always do",
        "never do",
        "prefer",
        "remember to",
        "from now on"
      ],
      "flow_category": "user_preferences"
    },
    {
      "id": 4,
      "from_directive": "user_preferences_update",
      "to_directive": "aifp_status",
      "flow_type": "completion_loop",
      "condition_key": null,
      "condition_value": null,
      "condition_description": null,
      "priority": 100,
      "description": "Preference updated, return to status",
      "flow_category": "user_preferences"
    },
    {
      "id": 5,
      "from_directive": "code_writing",
      "to_directive": "user_preferences_learn",
      "flow_type": "conditional",
      "condition_key": "user_correction_detected",
      "condition_value": "true",
      "condition_description": "AI detects user corrected output and learning is enabled",
      "priority": 60,
      "description": "AI detects correction pattern and offers to learn preference (requires ai_interaction_log tracking enabled)",
      "tracking_requirement": "ai_interaction_log must be enabled via tracking_toggle",
      "user_confirmation_required": true,
      "examples": [
        "User consistently adds docstrings AI omitted",
        "User consistently changes naming style",
        "User consistently modifies code structure"
      ],
      "flow_category": "user_preferences"
    },
    {
      "id": 6,
      "from_directive": "user_preferences_learn",
      "to_directive": "user_preferences_update",
      "flow_type": "canonical",
      "condition_key": "user_confirms_learning",
      "condition_value": "true",
      "condition_description": "User confirms AI should remember the inferred preference",
      "priority": 90,
      "description": "After inferring preference from correction, update directive_preferences if user confirms",
      "flow_category": "user_preferences"
    },
    {
      "id": 7,
      "from_directive": "user_preferences_learn",
      "to_directive": "aifp_status",
      "flow_type": "completion_loop",
      "condition_key": "user_declines_learning",
      "condition_value": "true",
      "condition_description": "User declines to save preference, just continue",
      "priority": 100,
      "description": "User declined learning preference, return to workflow",
      "flow_category": "user_preferences"
    },
    {
      "id": 8,
      "from_directive": "aifp_status",
      "to_directive": "user_preferences_export",
      "flow_type": "conditional",
      "condition_key": "user_requests_export",
      "condition_value": "true",
      "condition_description": "User requests to export preferences for backup or sharing",
      "priority": 70,
      "description": "Export user preferences to JSON file for backup or portability",
      "user_intent_keywords": [
        "export preferences",
        "backup settings",
        "save preferences"
      ],
      "flow_category": "user_preferences"
    },
    {
      "id": 9,
      "from_directive": "user_preferences_export",
      "to_directive": "aifp_status",
      "flow_type": "completion_loop",
      "condition_key": null,
      "condition_value": null,
      "condition_description": null,
      "priority": 100,
      "description": "Export complete, return to status",
      "flow_category": "user_preferences"
    },
    {
      "id": 10,
      "from_directive": "aifp_status",
      "to_directive": "user_preferences_import",
      "flow_type": "conditional",
      "condition_key": "user_requests_import",
      "condition_value": "true",
      "condition_description": "User requests to import preferences from file",
      "priority": 70,
      "description": "Import user preferences from JSON file (merge with existing, prompt on conflicts)",
      "user_intent_keywords": [
        "import preferences",
        "restore settings",
        "load preferences"
      ],
      "flow_category": "user_preferences"
    },
    {
      "id": 11,
      "from_directive": "user_preferences_import",
      "to_directive": "aifp_status",
      "flow_type": "completion_loop",
      "condition_key": null,
      "condition_value": null,
      "condition_description": null,
      "priority": 100,
      "description": "Import complete, return to status",
      "flow_category": "user_preferences"
    },
    {
      "id": 12,
      "from_directive": "aifp_status",
      "to_directive": "tracking_toggle",
      "flow_type": "conditional",
      "condition_key": "user_requests_tracking_toggle",
      "condition_value": "true",
      "condition_description": "User wants to enable or disable tracking features",
      "priority": 80,
      "description": "Toggle tracking features (fp_flow_tracking, ai_interaction_log, helper_function_logging, issue_reports, compliance_checking)",
      "user_intent_keywords": [
        "enable tracking",
        "disable tracking",
        "turn on logging",
        "turn off logging",
        "privacy settings"
      ],
      "tracking_features": [
        "fp_flow_tracking - Track FP directive consultations",
        "ai_interaction_log - Log user corrections and feedback",
        "helper_function_logging - Log directive execution performance",
        "issue_reports - Log errors and roadblocks",
        "compliance_checking - Track FP compliance patterns (opt-in analytics)"
      ],
      "flow_category": "user_preferences"
    },
    {
      "id": 13,
      "from_directive": "tracking_toggle",
      "to_directive": "aifp_status",
      "flow_type": "completion_loop",
      "condition_key": null,
      "condition_value": null,
      "condition_description": null,
      "priority": 100,
      "description": "Tracking setting updated, return to status",
      "flow_category": "user_preferences"
    },
    {
      "id": 14,
      "from_directive": "any_directive",
      "to_directive": "project_notes_log",
      "flow_type": "utility",
      "condition_key": "directive_needs_logging",
      "condition_value": "true",
      "condition_description": "Any directive can call project_notes_log to record clarifications or reasoning",
      "priority": 50,
      "description": "Log clarifications, reasoning, or directive context to project.db notes table",
      "note": "project_notes_log is a utility directive called by other directives, not part of main workflow. No loop-back to aifp_status.",
      "flow_category": "user_preferences"
    }
  ],
  "flow_summary": {
    "total_flows": 14,
    "by_flow_type": {
      "conditional": 8,
      "completion_loop": 5,
      "canonical": 1,
      "utility": 1
    },
    "by_priority": {
      "critical_100": 5,
      "high_80_90": 3,
      "medium_70": 2,
      "low_50_60": 2
    },
    "entry_points": {
      "from_aifp_run": 1,
      "from_aifp_status": 5,
      "from_code_writing": 1,
      "from_any_directive": 1
    }
  },
  "workflow_patterns": {
    "preference_loading": {
      "description": "Load preferences before executing customizable directives",
      "flow": "aifp_run → user_preferences_sync → aifp_status",
      "frequency": "Every time a customizable directive is executed",
      "caching": "Preferences cached for session duration"
    },
    "explicit_update": {
      "description": "User explicitly requests preference change",
      "flow": "aifp_status → user_preferences_update → aifp_status",
      "frequency": "Ad-hoc, when user wants to change behavior",
      "examples": [
        "User: 'Always add docstrings to functions'",
        "User: 'Never use global variables'",
        "User: 'Prefer list comprehensions over loops'"
      ]
    },
    "learned_update": {
      "description": "AI learns preference from user corrections",
      "flow": "code_writing → user_preferences_learn → [user confirms] → user_preferences_update → aifp_status",
      "frequency": "When AI detects correction pattern (opt-in)",
      "requirements": [
        "ai_interaction_log tracking must be enabled",
        "User must confirm preference before saving"
      ]
    },
    "backup_restore": {
      "description": "Export/import preferences for portability",
      "flows": [
        "aifp_status → user_preferences_export → aifp_status",
        "aifp_status → user_preferences_import → aifp_status"
      ],
      "frequency": "Rarely, for backup or sharing across projects",
      "format": "JSON (includes directive_preferences and user_settings)"
    },
    "privacy_control": {
      "description": "User controls tracking features",
      "flow": "aifp_status → tracking_toggle → aifp_status",
      "frequency": "Once per project (or when user changes privacy preference)",
      "default": "All tracking OFF by default",
      "granular_features": [
        "fp_flow_tracking - FP directive consultations",
        "ai_interaction_log - User corrections/feedback",
        "helper_function_logging - Directive execution performance",
        "issue_reports - Errors and roadblocks"
      ]
    },
    "logging_utility": {
      "description": "Any directive can log to project.db notes",
      "flow": "any_directive → project_notes_log (no loop-back)",
      "frequency": "As needed by individual directives",
      "use_cases": [
        "Record clarifications",
        "Document reasoning",
        "Log directive execution context",
        "Audit trail for decisions"
      ]
    }
  },
  "privacy_and_tracking": {
    "default_state": "All tracking features OFF by default",
    "opt_in_required": true,
    "tracking_features": {
      "fp_flow_tracking": {
        "description": "Track which FP directives AI consults during code writing",
        "database": "user_preferences.db",
        "table": "fp_flow_tracking",
        "purpose": "Understand which FP patterns AI references most",
        "enabled_by": "tracking_toggle directive"
      },
      "ai_interaction_log": {
        "description": "Log user corrections and feedback for preference learning",
        "database": "user_preferences.db",
        "table": "ai_interaction_log",
        "purpose": "Enable user_preferences_learn directive to infer preferences",
        "enabled_by": "tracking_toggle directive",
        "required_for": "user_preferences_learn to detect correction patterns"
      },
      "helper_function_logging": {
        "description": "Log directive execution outcomes (successes, retries, failures)",
        "database": "project.db",
        "table": "notes (with severity and directive_name)",
        "purpose": "Performance tracking and reliability analysis",
        "enabled_by": "tracking_toggle directive",
        "required_for": "project_performance_summary directive"
      },
      "issue_reports": {
        "description": "Log errors, roadblocks, and directive failures",
        "database": "project.db",
        "table": "notes",
        "purpose": "Error tracking and debugging",
        "enabled_by": "tracking_toggle directive"
      },
      "compliance_checking": {
        "description": "Track FP compliance patterns over time (analytics, NOT validation)",
        "database": "user_preferences.db",
        "table": "tracking_settings",
        "purpose": "Optional analytics for FP compliance patterns (audits, research, education)",
        "enabled_by": "tracking_toggle directive",
        "activates": "project_compliance_check directive (tracking-only)",
        "note": "FP compliance is baseline behavior. This tracks patterns, not validates code."
      }
    },
    "token_overhead_warning": "AI shows estimated token overhead before enabling tracking features",
    "user_control": "Granular per-feature toggle via tracking_toggle directive"
  },
  "integration_with_other_flows": {
    "project_directives": {
      "description": "Project directives check user_preferences_sync before execution",
      "directives": [
        "project_file_write - code style, docstrings, max function length, naming conventions, indent style",
        "project_task_decomposition - naming convention, auto-create items, default priority"
      ],
      "pattern": "Before execution → user_preferences_sync → load preferences → apply to context"
    },
    "user_system_directives": {
      "description": "User directive system checks preferences for customization",
      "directives": [
        "user_directive_validate - validation strictness",
        "user_directive_implement - code generation preferences"
      ],
      "pattern": "Same as project directives"
    },
    "fp_compliance": {
      "description": "FP compliance checking is opt-in tracking feature (NOT validation)",
      "directive": "project_compliance_check",
      "type": "tracking_only",
      "activation": "tracking_settings.compliance_checking = enabled",
      "preferences": [],
      "note": "No preferences - this is an analytics directive. FP compliance is baseline behavior enforced by system prompt.",
      "flow_location": "directive_flow_project.json"
    }
  },
  "helpers_used": [
    "query_settings(key) - Query user_settings table",
    "update_setting(key, value) - Update user_settings",
    "query_directive_preferences(directive_name) - Get preferences for directive",
    "upsert_directive_preference(directive_name, key, value) - Update directive preference",
    "find_directive_by_intent(user_request) - Map user intent to directive name",
    "log_to_notes(content, directive_name, severity) - Log to project.db notes"
  ],
  "notes": {
    "caching": "Preferences are cached for session duration after first load via user_preferences_sync",
    "conflict_resolution": "user_preferences_import prompts user on conflicts (keep existing, use imported, merge)",
    "learning_confirmation": "user_preferences_learn ALWAYS requires user confirmation before updating preferences",
    "tracking_default": "All tracking features OFF by default for privacy",
    "granular_control": "User can enable/disable individual tracking features via tracking_toggle",
    "no_execution_tracking": "User preferences do NOT track execution details unless explicitly enabled"
  }
}
